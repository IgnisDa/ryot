const pageSize =
	Number.isFinite(Number(context?.pageSize)) &&
	Number(context.pageSize) > 0 &&
	Number(context.pageSize) <= 100
		? Math.floor(Number(context.pageSize))
		: 20;
const currentPage = Number.isFinite(Number(context?.page))
	? Math.max(1, Math.floor(Number(context.page)))
	: 1;
const query = typeof context?.query === "string" ? context.query.trim() : "";

if (!query) throw new Error("query is required");

const parsePublishYear = (value) => {
	if (typeof value !== "string") return null;
	const trimmedValue = value.trim();
	if (!/^\d{4}$/.test(trimmedValue)) return null;

	const year = Number(trimmedValue);
	if (!Number.isFinite(year)) return null;

	return year;
};

const pickImage = (record) => {
	if (!record || typeof record !== "object") return null;

	const candidate = record?.image?.url?.original;
	if (typeof candidate !== "string") return null;

	const trimmedCandidate = candidate.trim();
	return trimmedCandidate || null;
};

const response = await httpCall(
	"POST",
	"https://api.mangaupdates.com/v1/series/search",
	{
		headers: { "Content-Type": "application/json" },
		body: JSON.stringify({
			search: query,
			perpage: pageSize,
			page: currentPage,
		}),
	},
);

if (!response?.success)
	throw new Error(response?.error ?? "MangaUpdates search request failed");

let payload;
try {
	payload = JSON.parse(response.data.body);
} catch {
	throw new Error("MangaUpdates returned invalid JSON");
}

const totalItems =
	typeof payload?.total_hits === "number" && Number.isFinite(payload.total_hits)
		? Math.max(0, Math.trunc(payload.total_hits))
		: 0;

const results = Array.isArray(payload?.results) ? payload.results : [];
const items = results
	.map((item) => {
		const record = item?.record && typeof item.record === "object" ? item.record : null;
		if (!record) return null;

		const seriesId =
			typeof record.series_id === "number" && Number.isFinite(record.series_id)
				? Math.trunc(record.series_id)
				: null;
		if (seriesId === null || seriesId <= 0) return null;

		const hitTitle = typeof item?.hit_title === "string" ? item.hit_title : "";
		const title =
			hitTitle || (typeof record.title === "string" ? record.title : "");

		return {
			title,
			identifier: String(seriesId),
			image: pickImage(record),
			publish_year: parsePublishYear(record.year),
		};
	})
	.filter((item) => item !== null);

return {
	items,
	details: {
		total_items: totalItems,
		next_page: currentPage * pageSize < totalItems ? currentPage + 1 : null,
	},
};

const stdinBytes = await new Response(Deno.stdin.readable).arrayBuffer();
const payload = JSON.parse(new TextDecoder().decode(stdinBytes));

const code = payload.code;
const token = payload.token;
const apiBase = payload.apiBase;
const context = payload.context ?? {};
const executionId = payload.executionId;
const apiFunctions = payload.apiFunctions ?? [];

const stderrEncoder = new TextEncoder();

const writeStderr = (value) => {
	Deno.stderr.writeSync(stderrEncoder.encode(`${String(value)}\\n`));
};

const formatArg = (value) => {
	if (typeof value === "string") return value;
	try {
		return JSON.stringify(value);
	} catch {
		return String(value);
	}
};

console.log = (...args) => writeStderr(args.map(formatArg).join(" "));
console.warn = (...args) =>
	writeStderr(`[warn] ${args.map(formatArg).join(" ")}`);
console.error = (...args) =>
	writeStderr(`[error] ${args.map(formatArg).join(" ")}`);
console.info = console.log;
console.debug = console.log;

const writeResult = (payload) => {
	Deno.stdout.writeSync(stderrEncoder.encode(JSON.stringify(payload)));
};

const createApiStub = (fnName) => {
	return async (...args) => {
		const response = await fetch(`${apiBase}/rpc/${executionId}/${fnName}`, {
			method: "POST",
			body: JSON.stringify({ args }),
			headers: {
				Authorization: "Bearer " + token,
				"Content-Type": "application/json",
			},
		});

		const body = await response.json();

		if (!response.ok) throw new Error(body.error ?? "API call failed");

		return body.result;
	};
};

const stubs = {};
for (const fnName of apiFunctions) {
	stubs[fnName] = createApiStub(fnName);
}

try {
	const stubNames = Object.keys(stubs);
	const wrapperCode =
		"return (async function sandboxMain({ " +
		stubNames.join(", ") +
		" }, context) {\n" +
		code +
		"\n})";

	const factory = new Function(wrapperCode);
	const userFunction = factory();
	const value = await userFunction(stubs, context);

	writeResult({ success: true, value: value ?? null });
} catch (error) {
	writeResult({
		success: false,
		error: error instanceof Error ? error.message : String(error),
	});
}
